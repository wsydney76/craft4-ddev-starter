{# Execute this JavaScript in preview mode only #}
{# https://aaronmbushnell.com/hot-reloading-content-in-craft-cms-live-preview/ #}

{% if craft.app.edition == 1 and  craft.app.request.isPreview and customConfig.enableHotReload %}
    {# Include Alpine.js and the Morph plugin #}
    <script>
        {# Listen for postMessage() calls #}
        window.addEventListener('message', async (event) => {
            {# Ignore messages that don't use our live preview key #}
            if (event.data !== 'entry:live-preview:updated') {
                return
            }

            {# Grab the URL we need to process from the event, send it to a fetch() call, and then parse the text #}
            const text = await fetch(event.target.location.href).then((res) => res.text())

            {# Process the text as HTML #}
            const updated = new DOMParser().parseFromString(text, 'text/html')

            {# Use Alpine.js's morph plugin to diff the existing DOM to the new HTML and update the page #}
            Alpine.morph(document.body, updated.body)
        })
    </script>
{% endif %}